---
- name: Set Timestamp
  ansible.builtin.set_fact:
    time: "{{ lookup('pipe', 'date \"+%Y-%m-%d-%H-%M\"') }}"
  run_once: true
  tags: always

- name: Create default tag
  ansible.builtin.set_fact:
    default_tag:
      annotation: "{{ time }}"
      message: "backup_on: {{ time }}"
  tags: always

- name: Set default tag
  ansible.builtin.set_fact:
    default_tag: "{}"
  when:
    - tag is defined
    - tag  == "default"
  tags: always

- name: Check if there are actual changes to commit
  ansible.builtin.command:
    cmd: git -C "{{ network_backup_path_root }}" status --porcelain
  register: git_status_check
  changed_when: false
  failed_when: false
  tags: always

- name: Set fact if there are changes
  ansible.builtin.set_fact:
    git_has_changes: "{{ git_status_check.stdout | length > 0 }}"
  tags: always

- name: Publish the changes with tag
  ansible.scm.git_publish:
    path: "{{ network_backup_path_root }}"
    token: "{{ data_store.scm.origin.get('token') if data_store.scm.origin.get('token') else omit }}"
    user: "{{ data_store['scm']['origin']['user'] | d({}) }}"
    tag: "{{ tag }}"
    timeout: 120
    ssh_key_file: "{{ data_store.scm.origin.get('ssh_key_file') if data_store.scm.origin.get('ssh_key_file') else omit }}"
    ssh_key_content: "{{ data_store.scm.origin.get('ssh_key_content') if data_store.scm.origin.get('ssh_key_content') else omit }}"
  when: 
    - tag is defined
    - git_has_changes | default(true)
  tags: always

- name: Publish the changes
  ansible.scm.git_publish:
    path: "{{ network_backup_path_root }}"
    token: "{{ data_store.scm.origin.get('token') if data_store.scm.origin.get('token') else omit }}"
    user: "{{ data_store['scm']['origin']['user'] | d({}) }}"
    timeout: 120
    ssh_key_file: "{{ data_store.scm.origin.get('ssh_key_file') if data_store.scm.origin.get('ssh_key_file') else omit }}"
    ssh_key_content: "{{ data_store.scm.origin.get('ssh_key_content') if data_store.scm.origin.get('ssh_key_content') else omit }}"
  when: 
    - tag is not defined
    - git_has_changes | default(true)
  tags: always

- name: Display message when no changes to publish
  ansible.builtin.debug:
    msg: "No changes detected in Git repository - skipping publish (file content is identical to existing backup)"
  when: 
    - git_has_changes is defined
    - not (git_has_changes | default(true))
  tags: always

- name: Remove cloned repository directory
  ansible.builtin.file:
    path: "{{ network_backup_path_root }}"
    state: absent
  tags: always
